# SSH Forwarder 设计文档

## 概述

一个简单的SSH多路复用代理服务器，使用Go语言开发，跨平台运行。

## 功能特性

- **多路复用**：多个本地客户端连接共享同一个底层SSH连接
- **Channel隔离**：SSH Channel天然隔离不同客户端的数据流
- **灵活认证**：支持无认证、用户名+密码认证
- **详细日志**：调试级别的详细日志输出

## 架构设计

```
┌─────────────────────────────────────────────────┐
│              代理进程（对应一台远程服务器）        │
├─────────────────────────────────────────────────┤
│  ┌─────────────┐      ┌─────────────────────┐  │
│  │  Listener   │ ────▶│  SSH Client         │  │
│  │  (TCP)      │      │  (单个SSH连接)       │  │
│  └─────────────┘      │                     │  │
│                       │  ┌───────────────┐   │  │
│                       │  │ Channel池    │   │  │
│                       │  │ (多路复用)   │   │  │
│                       │  └───────────────┘   │  │
│                       └─────────────────────┘  │
└─────────────────────────────────────────────────┘
```

### 组件职责

| 组件 | 职责 |
|-----|------|
| `Listener` | 监听本地TCP端口，接受客户端连接 |
| `SSHClient` | 管理单个SSH连接，建立Channel |
| `ChannelManager` | 管理Channel生命周期，回收复用 |
| `Forwarder` | 客户端 ↔ Channel 双向数据转发 |

## 启动参数

| 参数 | 必填 | 默认值 | 说明 |
|-----|------|--------|------|
| `--local-port` | 是 | - | 本地监听端口 |
| `--local-ip` | 否 | 0.0.0.0 | 本地监听IP |
| `--remote-host` | 是 | - | 远程SSH服务器地址 |
| `--remote-port` | 否 | 22 | 远程SSH端口 |
| `--username` | 否 | - | SSH用户名（无认证不填） |
| `--password` | 否 | - | SSH密码（无认证不填） |

## 数据流

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 客户端    │ ──▶ │  Listener│ ──▶ │ Channel  │ ──▶ │ 远程SSH  │
│          │     │ (Accept) │     │ (Req/Open)│     │ Server  │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
                                           │
                                           │ 双向数据
                                           ▼
                                    ┌──────────┐
                                    │  Copy    │
                                    │  (io.Copy)│
                                    └──────────┘
```

## 项目结构

```
ssh-forwarder/
├── main.go              # 程序入口，参数解析
├── cmd/
│   └── root.go          # 命令定义
├── config/
│   └── config.go        # 配置结构体
├── listener/
│   └── listener.go      # TCP监听器
├── ssh/
│   ├── client.go        # SSH客户端管理
│   ├── channel.go       # Channel管理
│   └── auth.go          # 认证相关
├── forwarder/
│   └── forwarder.go     # 数据转发逻辑
└── go.mod
```

## 依赖

```go
require (
    golang.org/x/crypto v0.31.0  // SSH协议实现
)
```

## 使用示例

```bash
# 有认证连接
./ssh-forwarder \
    --local-port 2222 \
    --remote-host test.devpod \
    --username root \
    --password pass123

# 无认证连接
./ssh-forwarder \
    --local-port 2222 \
    --remote-host 192.168.1.100
```

## 行为说明

- **退出策略**：收到SIGINT/SIGTERM信号立即关闭
- **日志级别**：详细调试日志
- **多实例**：不同服务器启动不同代理进程，互不干扰
